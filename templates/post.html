{% extends 'base.html' %}
{% block title %}Chat{% endblock title %}
{% block content %}
    <h1>{{ post.title }}</h1>
    <p>{{ post.content }}</p>
    <p>{{ post.date_posted }}</p>
    <form method="POST" action="{% url 'like_post' post.id %}" id="like-form">
        {% csrf_token %}
        <input type="submit" value="Like" id="like-button"
        {% if isLiked %}
            class="btn btn-primary"
        {% else %}
            class="btn btn-outline-primary"
        {% endif %}>
    </form>
    <p>Likes: <span id="likes-count">{{ post_likes }}</span></p>
    <!-- Add a unique identifier to the comment form to make it easier to select with JavaScript -->
    <ul id="comments-list">
        {% for comment, likes, isLiked in comments %}
            <li id="comment-{{ comment.id }}">
                <p>{{ comment.content }}</p>
                <form method="POST" action="{% url 'like_comment' post_id=post.id comment_id=comment.id %}" class="comment-like-form">
                    {% csrf_token %}
                    <input type="hidden" name="comment_id" value="{{ comment.id }}">
                    <input type="submit" value="Like" id="like-button-{{ comment.id }}"
                    {% if isLiked %}
                        class="btn btn-primary"
                    {% else %}
                        class="btn btn-outline-primary"
                    {% endif %}>
                </form>
                <p>Likes: <span id="likes-count-{{ comment.id }}">{{ likes }}</span></p>
                {% if comment.author == post.author %}
                    <p>By OP on {{ comment.date_posted }}</p>
                {% elif comment.author == request.user %}
                    <p>By You on {{ comment.date_posted }}</p>
                {% else %}
                    <p>By Anonymous on {{ comment.date_posted }}</p>
                {% endif %}
            </li>
        {% endfor %}
    </ul>
    
    <form method="POST" action="{% url 'create_comment' post.id %}" id="comment-form">
        {% csrf_token %}
        <input type="text" name="content">
        <input type="submit" value="Add Comment">
    </form>

    <script>
        const sendAjaxRequest = (method, url, headers = {}, body = null) => {
          const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]').value;
          headers['X-CSRFToken'] = csrfToken;
          
            return fetch(url, { method, headers, body })
            .then(response => response.json())
            .catch(error => console.error(error));
        };
      
        // Send AJAX request when comment form is submitted
        const commentForm = document.querySelector('#comment-form');
        commentForm.addEventListener('submit', (event) => {
            event.preventDefault();
            const url = event.target.action;
            const method = 'POST';
            const body = new FormData(event.target);
            sendAjaxRequest(method, url, {}, body)
                .then(data => {
                // Add the new comment to the comments list
                const commentsList = document.querySelector('#comments-list');
                const newComment = `
                    <li id="comment-${data.comment_id}">
                        <p>${data.content}</p>
                        <form method="POST" action="comment/${data.id}/like/" class="comment-like-form">
                            {% csrf_token %}
                            <input type="hidden" name="comment_id" value="${data.d}">
                            <input type="submit" value="Like" id="like-button-${data.id}" class="btn btn-outline-primary">
                        </form>
                        <p>Likes: <span id="likes-count-${data.id}">0</span></p>
                        <p>By You on ${data.date_posted}</p>
                `;
                commentsList.insertAdjacentHTML('beforeend', newComment);
                // Reset the comment form
                event.target.reset();
                });
        });
      
        // Send AJAX request when like button is clicked
        const likeForm = document.querySelector('#like-form');
        likeForm.addEventListener('submit', (event) => {
            event.preventDefault();
            const url = event.target.action;
            const method = 'POST';
            sendAjaxRequest(method, url)
            .then(data => {
                // Update the like button style and the like count based on the response
                const likeButton = document.querySelector('#like-button');
                const likesCount = document.querySelector('#likes-count');
                if (data.liked) {
                    likeButton.classList.remove('btn-outline-primary');
                    likeButton.classList.add('btn-primary');
                    likesCount.textContent = data.likes;
                } else {
                    likeButton.classList.remove('btn-primary');
                    likeButton.classList.add('btn-outline-primary');
                    likesCount.textContent = data.likes;
                }
            });
        });
      
        // Send AJAX request when like button is clicked
        const commentsList = document.querySelector('#comments-list');
        commentsList.addEventListener('submit', (event) => {
            if (event.target.matches('.comment-like-form')) {
                event.preventDefault();
                const url = event.target.action;
                const method = 'POST';
                sendAjaxRequest(method, url)
                .then(data => {
                    // Update the like button style and the like count based on the response
                    const commentId = data.comment_id;
                    const likeButton = document.querySelector(`#like-button-${commentId}`);
                    const likesCount = document.querySelector(`#likes-count-${commentId}`);
                    if (data.liked) {
                        likeButton.classList.remove('btn-outline-primary');
                        likeButton.classList.add('btn-primary');
                        likesCount.textContent = data.likes;
                    } else {
                        likeButton.classList.remove('btn-primary');
                        likeButton.classList.add('btn-outline-primary');
                        likesCount.textContent = data.likes;
                    }
                });
            }
        });
      </script>
      
{% endblock content %}